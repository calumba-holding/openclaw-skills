# Smart Router 决策流程图

**版本：** 1.0  
**创建时间：** 2026-02-24  
**用途：** 快速理解路由决策逻辑

---

## 🌊 完整决策流程

```
┌─────────────────────────────────────────────────────────────┐
│                    用户输入文本                              │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────┐
│              第一层：极速嗅探器（<1ms）                       │
│                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │ 长度检测    │  │ 特征词检测  │  │ 表情符号检测│        │
│  │ <2k/2k-10k  │  │ 问号/情感/  │  │ 😊❤️😢     │        │
│  │ >10k        │  │ 结构/知识   │  │             │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
          ┌──────────────────────┐
          │   嗅探标签输出       │
          │ short/medium/long    │
          │ question/emotion     │
          │ structure/knowledge  │
          └──────────┬───────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────┐
│              第二层：动态路由网关（决策核心）                  │
│                                                             │
│                     ┌─────────────┐                         │
│                     │ 短文本？    │                         │
│                     │ <2000 字符  │                         │
│                     └──────┬──────┘                         │
│                            │                                │
│              ┌─────────────┴─────────────┐                  │
│              │ YES                       │ NO               │
│              ▼                           ▼                  │
│     ┌─────────────────┐         ┌─────────────────┐        │
│     │ 有问号/情感？   │         │ 有结构词？      │        │
│     └────────┬────────┘         └────────┬────────┘        │
│              │                           │                 │
│     ┌────────┴────────┐         ┌────────┴────────┐        │
│     │ YES             │ NO      │ YES             │ NO     │
│     ▼                 ▼         ▼                 ▼        │
│  ┌──────┐      ┌──────────┐ ┌──────┐      ┌──────────┐    │
│  │版本 A│      │ 有知识词？│ │版本 B│      │版本 C    │    │
│  │⚡️   │      └────┬─────┘ │📋    │      │🧠        │    │
│  └──────┘           │       └──────┘      └──────────┘    │
│                     │                                      │
│           ┌─────────┴─────────┐                            │
│           │ YES               │ NO                         │
│           ▼                   ▼                            │
│        ┌──────┐         ┌──────────┐                       │
│        │版本 C│         │版本 C    │                       │
│        │🧠    │         │🧠        │                       │
│        └──────┘         └──────────┘                       │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────┐
│              第三层：前端表现层                               │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  徽章显示 + 版本说明 + 压缩处理                      │   │
│  │                                                     │   │
│  │  版本 A → [⚡️ 灵动模式] 精炼流畅，保持流动感        │   │
│  │  版本 B → [📋 结构模式] 结构清晰，快速定位          │   │
│  │  版本 C → [🧠 深度无损模式] 质量优先，语义保留 97%+ │   │
│  └─────────────────────────────────────────────────────┘   │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
          ┌──────────────────────┐
          │   输出 4D 压缩结果    │
          │   + 徽章 + 路由说明   │
          └──────────────────────┘
```

---

## 📋 快速决策表

| 条件 1 | 条件 2 | 条件 3 | 路由版本 | 徽章 |
|--------|--------|--------|----------|------|
| 短文本 (<2k) | 有问号 | - | **A** | ⚡️ 灵动模式 |
| 短文本 (<2k) | 有情感词 | - | **A** | ⚡️ 灵动模式 |
| 任意长度 | - | 有结构词 | **B** | 📋 结构模式 |
| 任意长度 | - | 有知识词 | **C** | 🧠 深度无损 |
| 长文本 (≥2k) | - | - | **C** | 🧠 深度无损 |
| 无法分类 | - | - | **C** (默认) | 🧠 深度无损 |

---

## 🎯 典型场景示例

### **场景 1：对话记录**
```
输入："指挥官：Neo，你的信念有问题。Neo：有问题？"
嗅探：short + question
路由：版本 A ⚡️
```

### **场景 2：情感表达**
```
输入："我今天好开心！😄 每一次行动都创造价值！"
嗅探：short + emotion
路由：版本 A ⚡️
```

### **场景 3：数据报告**
```
输入："## 数据分析 1.用户增长 2.收入统计 因此增长 150%"
嗅探：structure
路由：版本 B 📋
```

### **场景 4：哲学理论**
```
输入："# UPTEF 框架 选择力是方向决策的能力..."
嗅探：knowledge
路由：版本 C 🧠
```

### **场景 5：项目日志**
```
输入："## 项目日志 任务完成：1.三书处理 2.系统动力学..."
嗅探：structure
路由：版本 B 📋（或 C，边界情况）
```

### **场景 6：知识学习**
```
输入："今天学习了系统动力学，三条法则：动变前..."
嗅探：knowledge
路由：版本 C 🧠
```

---

## 🔄 路由规则优先级

```
1. 短文本 + 问号/情感 → 版本 A（最高优先级）
2. 有结构词 → 版本 B
3. 有知识词 → 版本 C
4. 长文本 → 版本 C
5. 默认 → 版本 C（最低优先级）
```

**注意：** 规则按顺序匹配，一旦匹配成功即停止

---

## 📊 版本分布预期

基于 T1-T5 实验和用户行为预测：

| 版本 | 预期占比 | 典型场景 |
|------|----------|----------|
| **A** | 20% | 对话、情感、问答 |
| **B** | 10% | 数据报告、技术文档 |
| **C** | 70% | 知识学习、项目日志、理论、默认 |

---

## 🛠️ 调试指南

### **查看路由日志**
```bash
cat /Users/abc/.openclaw/workspace/skills/smart-router/logs/router-YYYY-MM-DD.log
```

### **手动测试路由**
```bash
node router.js "测试文本"
```

### **查看嗅探规则**
```bash
cat sniff-rules.json
```

### **查看徽章配置**
```bash
cat badge-config.json
```

---

## 📝 优化记录

### **v1.0（当前）**
- 基础路由逻辑实现
- 5 段测试文本验证通过
- 日志记录功能

### **v1.1（计划）**
- [ ] 项目日志专属关键词
- [ ] 用户满意度收集
- [ ] 边界情况优化

### **v2.0（未来）**
- [ ] 机器学习优化（可选）
- [ ] 个性化路由偏好
- [ ] A/B 测试框架

---

**流程图版本：** 1.0  
**更新时间：** 2026-02-24  
**状态：** ✅ 已完成
